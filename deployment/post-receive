#!/bin/bash
TARGET="/root/crawler"
GIT_DIR="/var/repo/crawler.git"
BRANCH="main"

while read oldrev newrev ref
do
    if [[ $ref =~ .*/$BRANCH$ ]];
    then
        echo "Ref $ref received. Deploying ${BRANCH} branch to production..."
        mkdir -p $TARGET
        git --work-tree=$TARGET --git-dir=$GIT_DIR checkout -f $BRANCH
        
        # Install dependencies
        if [ -f "$TARGET/backend/requirements.txt" ]; then
            echo "Installing dependencies..."
            cd $TARGET/backend
            # Check for venv
            if [ -d ".venv" ]; then
                source .venv/bin/activate
                pip install -r requirements.txt
            else
                # Try pip install, might require --break-system-packages on recent OS
                pip install -r requirements.txt || pip install -r requirements.txt --break-system-packages
            fi
        fi
        
        # Restart service
        echo "Restarting service..."
        systemctl restart crawler-backend
        echo "Deployment finished!"
    else
        echo "Ref $ref received. Doing nothing: only the ${BRANCH} branch may be deployed on this server."
    fi
done
